<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#4a6fa5" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø®ØµÙŠØ©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#4a6fa5;--secondary:#166088;--accent:#4fc3f7;--success:#2e7d32;--warning:#ff8f00;--danger:#c62828;
  --light:#f5f7fa;--white:#fff;--text:#333;--muted:#667085;--border:#e5e7eb;
  --radius:12px;--shadow:0 4px 12px rgba(0,0,0,.08);--trans:all .25s ease;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Tajawal',sans-serif;background:var(--light);color:var(--text);padding:20px;line-height:1.6}
.container{max-width:900px;margin:auto;background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;position:relative;overflow:hidden}
.container::before{content:'';position:absolute;top:0;right:0;width:100%;height:8px;background:linear-gradient(90deg,var(--primary),var(--accent))}
h1{color:var(--primary);text-align:center;margin-bottom:18px;font-size:26px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:780px){.grid{grid-template-columns:1fr}}
.section{background:#fafbff;border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.section-title{display:flex;align-items:center;gap:8px;color:var(--primary);font-weight:700;margin-bottom:10px}
label{display:block;margin:.5rem 0 .25rem 0;font-weight:500}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-family:'Tajawal',sans-serif;font-size:15px;transition:var(--trans);background:#fff}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,195,247,.18)}
.row{display:flex;gap:10px}
.row>*{flex:1}
button{appearance:none;border:none;border-radius:10px;padding:12px;cursor:pointer;font-weight:700;transition:var(--trans)}
.btn{background:var(--primary);color:#fff}
.btn:hover{background:var(--secondary);transform:translateY(-1px)}
.btn-success{background:var(--success);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-ghost{background:#eef2ff;color:#1e293b}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff;color:#475569}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px}
.muted{color:var(--muted);font-size:13px}
.result-card{border-top:3px solid var(--primary)}
.kv{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
.kv:last-child{border-bottom:none}
.alert{padding:10px;border-radius:10px;margin:10px 0;font-weight:600;display:flex;gap:8px;align-items:center}
.alert-success{background:#e8f5e9;color:var(--success);border-right:3px solid var(--success)}
.alert-warning{background:#fff3e0;color:var(--warning);border-right:3px solid var(--warning)}
.alert-danger{background:#ffebee;color:var(--danger);border-right:3px solid var(--danger)}
.day-card{background:#fff;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;padding:12px}
.day-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:8px}
.expense-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:#f8fafc;border:1px dashed #e5e7eb;padding:8px;border-radius:10px;margin-bottom:6px}
.expense-meta{font-size:13px;color:#475569}
.actions button{background:transparent;color:#0f172a;padding:6px 8px}
.progress{height:8px;border-radius:999px;background:#eef2ff;overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--accent))}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.small{font-size:12px;color:#64748b}
.hr{height:1px;background:#eee;margin:10px 0}
#chartWrap{padding:12px}
#chart{width:100%;height:200px}
.switch{display:inline-flex;align-items:center;gap:8px}
.switch input{width:auto}
.dark body{background:#0b1220;color:#e2e8f0}
.dark .container{background:#0f172a}
.dark .section,.dark .card,.dark .day-card{background:#0b1220;border-color:#1e293b}
.dark input,.dark select,.dark textarea{background:#0b1220;border-color:#1e293b;color:#e2e8f0}
.dark .btn-ghost{background:#111827;color:#e5e7eb}
</style>
</head>
<body>
<div class="container">
  <h1>ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>

  <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ -->
  <div class="toolbar">
    <span class="badge">ğŸ“… <span id="todayLabel"></span></span>
    <span class="badge">ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±: <span id="monthLabel"></span></span>
    <label class="switch"><input type="checkbox" id="darkToggle"> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</label>
    <button class="btn-ghost" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    <button class="btn-ghost" id="exportCsvBtn">â¬‡ï¸ CSV</button>
    <button class="btn-ghost" id="exportJsonBtn">â¬‡ï¸ JSON</button>
    <label class="btn-ghost" style="cursor:pointer">
      â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
      <input type="file" id="importJsonInput" accept=".json" style="display:none">
    </label>
  </div>

  <div class="grid">
    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <div class="section">
      <div class="section-title">ğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
      <div class="row">
        <div>
          <label for="salary">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
          <input type="number" id="salary" placeholder="Ù…Ø«Ø§Ù„: 700" min="0" step="0.01">
        </div>
        <div>
          <label for="fixed">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label>
          <input type="number" id="fixed" placeholder="Ù…Ø«Ø§Ù„: 250" min="0" step="0.01">
        </div>
      </div>
      <button class="btn-success" id="calcBtn">ğŸ§® Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
      <div id="settingsCard" class="card result-card" style="margin-top:10px"></div>
    </div>

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ… -->
    <div class="section">
      <div class="section-title">ğŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <div class="row">
        <div>
          <label for="extra">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</label>
          <input type="number" id="extra" placeholder="Ù…Ø«Ø§Ù„: 10" min="0" step="0.01">
        </div>
        <div style="align-self:end">
          <button class="btn" id="addExtraBtn">â• Ø£Ø¶Ù Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="amount">Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…</label>
          <input type="number" id="amount" placeholder="Ù…Ø«Ø§Ù„: 5.75" min="0" step="0.01">
        </div>
        <div>
          <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="category">
            <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
            <option value="Ø·Ø¹Ø§Ù…">Ø·Ø¹Ø§Ù…</option>
            <option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option>
            <option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option>
            <option value="ØªØ±ÙÙŠÙ‡">ØªØ±ÙÙŠÙ‡</option>
            <option value="ØµØ­Ø©">ØµØ­Ø©</option>
            <option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
          </select>
        </div>
      </div>
      <label for="note">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="note" placeholder="Ù…Ø«Ø§Ù„: ØºØ¯Ø§Ø¡ Ø¹Ù…Ù„ / Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª / ...">
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addExpenseBtn">ğŸ§¾ Ø£Ø¶Ù Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        <button class="btn-warning" id="clearTodayBtn">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</button>
      </div>

      <div id="todayPanel" class="card result-card" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Ù…Ù„Ø®ØµØ§Øª ÙˆÙÙ„ØªØ±Ø© -->
  <div class="grid" style="margin-top:16px">
    <div class="section">
      <div class="section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙ…Ù„Ø®Øµ</div>
      <div id="stats" class="card"></div>
      <div id="chartWrap" class="card">
        <canvas id="chart"></canvas>
        <div class="small">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</div>
      </div>
      <div id="weeklySummary" class="card" style="display:none"></div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ” ÙÙ„ØªØ±Ø© ÙˆØ¹Ø±Ø¶</div>
      <div class="row">
        <div>
          <label for="fromDate">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="fromDate">
        </div>
        <div>
          <label for="toDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="toDate">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="applyFilterBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
        <button class="btn-ghost" id="resetFilterBtn">Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
      </div>

      <div class="hr"></div>

      <div class="section-title">ğŸ¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
      <div class="row">
        <select id="budgetCat">
          <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option><option value="Ø·Ø¹Ø§Ù…">Ø·Ø¹Ø§Ù…</option><option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option>
          <option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option><option value="ØªØ±ÙÙŠÙ‡">ØªØ±ÙÙŠÙ‡</option>
          <option value="ØµØ­Ø©">ØµØ­Ø©</option><option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
        </select>
        <input type="number" id="budgetVal" placeholder="Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø´Ù‡Ø±ÙŠØ© Ù„Ù„ØªØµÙ†ÙŠÙ" min="0" step="0.01">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveBudgetBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
        <button class="btn-ghost" id="clearBudgetsBtn">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</button>
      </div>

      <div id="budgetsView" class="card" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠØ§Ù… -->
  <div class="section" style="margin-top:16px">
    <div class="section-title">ğŸ“… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
    <div id="expenseList"></div>
  </div>

  <div class="toolbar" style="justify-content:space-between;margin-top:10px">
    <button class="btn-ghost" id="restoreBtn" style="display:none">ğŸ”„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
    <button class="btn-danger" id="resetBtn">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>
</div>

<!-- Ø­ÙˆØ§Ø±Ø§Øª Ø¨Ø³ÙŠØ·Ø© -->
<div id="confirmModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:9999">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:380px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.2)">
    <div id="confirmMsg" style="margin-bottom:14px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn-success" id="confirmOk">Ù…ÙˆØ§ÙÙ‚</button>
      <button class="btn-danger" id="confirmCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
/* ---------- Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ® ---------- */
const fmtDate = (d)=>{ // ISO Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚ÙŠØª
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
};
const parseISO = (s)=> new Date(`${s}T00:00:00`);
const daysAr = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
const dayName = (iso)=>{ const d=parseISO(iso); return isNaN(d)?'â“':daysAr[d.getDay()] };
const daysInMonth = (y,m)=> new Date(y,m,0).getDate(); // m=1..12

/* ---------- Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ---------- */
const K = {
  salary:'saved_salary', fixed:'saved_expenses', daily:'daily_limit', plan:'saving_plan',
  percent:'saving_percent', last:'last_date', carry:'carry', exps:'expenses',
  extra:'extra_income', budgets:'category_budgets', backup:'backup_data', monthKey:'active_month'
};

/* ---------- Ø£Ø¯ÙˆØ§Øª ØªØ®Ø²ÙŠÙ† ---------- */
const readJSON = (k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } };
const writeJSON = (k,val)=> localStorage.setItem(k, JSON.stringify(val));
const num = (v)=> { const n=parseFloat(v); return isNaN(n)?0:n };

/* ---------- ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯ ---------- */
function confirmBox(msg, cb){
  const modal = document.getElementById('confirmModal');
  document.getElementById('confirmMsg').innerHTML = msg;
  modal.style.display='flex';
  const ok = document.getElementById('confirmOk');
  const cancel = document.getElementById('confirmCancel');
  const clean = ()=>{ modal.style.display='none'; ok.onclick=null; cancel.onclick=null; };
  ok.onclick=()=>{ clean(); cb(true); };
  cancel.onclick=()=>{ clean(); cb(false); };
}

/* ---------- ØªÙ‡ÙŠØ¦Ø© ---------- */
const todayISO = fmtDate(new Date());
document.getElementById('todayLabel').textContent = todayISO;
document.getElementById('monthLabel').textContent = todayISO.slice(0,7);

/* ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† */
const darkToggle = document.getElementById('darkToggle');
try{
  const dark = localStorage.getItem('__dark__')==='1';
  darkToggle.checked = dark;
  if(dark) document.documentElement.classList.add('dark');
}catch{}
darkToggle.addEventListener('change', ()=>{
  if(darkToggle.checked){ localStorage.setItem('__dark__','1'); document.documentElement.classList.add('dark'); }
  else { localStorage.setItem('__dark__','0'); document.documentElement.classList.remove('dark'); }
});

/* Ø¥Ø°Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
if(window.Notification && Notification.permission!=='granted'){ Notification.requestPermission().catch(()=>{}); }

/* ---------- ØªØ±Ø­ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± ---------- */
(function monthRollover(){
  const currentMonth = todayISO.slice(0,7);
  const savedMonth = localStorage.getItem(K.monthKey);
  if(savedMonth && savedMonth!==currentMonth){
    // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©ØŒ ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©/Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    localStorage.setItem(K.carry,'0');
    writeJSON(K.extra, {}); // Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ ÙŠØ¹Ø§Ø¯ Ø´Ù‡Ø±ÙŠØ§Ù‹
  }
  localStorage.setItem(K.monthKey, currentMonth);
})();

/* ---------- Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ ---------- */
function calculate(isUpdate=false){
  const salary = num(document.getElementById('salary').value);
  const fixed = num(document.getElementById('fixed').value);
  if(salary<=0){ alert('âŒ Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ø§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹'); return; }
  if(fixed<0){ alert('âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØµØ§Ù„Ø­Ø©'); return; }

  localStorage.setItem(K.salary, String(salary));
  localStorage.setItem(K.fixed, String(fixed));

  const netBeforeSaving = salary - fixed;
  let p = 0;
  if(netBeforeSaving < 100) p = 5;
  else if(netBeforeSaving < 200) p = 10;
  else if(netBeforeSaving < 400) p = 15;
  else p = 20;

  const saveAmt = salary * p / 100;
  const now = new Date(); const dim = daysInMonth(now.getFullYear(), now.getMonth()+1);
  const net = salary - fixed - saveAmt;
  const daily = Math.max(net/dim, 0);

  localStorage.setItem(K.daily, daily.toFixed(2));
  localStorage.setItem(K.plan, saveAmt.toFixed(2));
  localStorage.setItem(K.percent, String(p));
  localStorage.setItem(K.last, todayISO);
  localStorage.setItem(K.monthKey, todayISO.slice(0,7));

  if(!isUpdate){
    localStorage.setItem(K.carry,'0');
    writeJSON(K.exps, readJSON(K.exps, [])); // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    writeJSON(K.extra, readJSON(K.extra, {}));
  }

  updateUI();
}

/* ---------- Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ ---------- */
function addExtra(){
  const a = num(document.getElementById('extra').value);
  if(a<=0) return;
  const extras = readJSON(K.extra, {});
  extras[todayISO] = (extras[todayISO]||0) + a;
  writeJSON(K.extra, extras);
  document.getElementById('extra').value='';
  updateUI();
}

/* ---------- Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ ---------- */
function addExpense(){
  const amount = num(document.getElementById('amount').value);
  if(amount<=0) return;
  const cat = document.getElementById('category').value || 'Ø¹Ø§Ù…';
  const note = (document.getElementById('note').value||'').trim();
  const list = readJSON(K.exps, []);
  const item = { id: crypto.randomUUID ? crypto.randomUUID() : (Date.now()+''+Math.random()), amount, date: todayISO, category: cat, note };
  list.push(item);
  writeJSON(K.exps, list);
  document.getElementById('amount').value='';
  document.getElementById('note').value='';
  updateUI();
}

/* ---------- ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø¹Ù†ØµØ± ---------- */
function deleteExpense(id){
  const list = readJSON(K.exps, []);
  const idx = list.findIndex(x=>x.id===id);
  if(idx<0) return;
  confirmBox('ğŸ—‘ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ', (ok)=>{
    if(!ok) return;
    list.splice(idx,1);
    writeJSON(K.exps, list);
    updateUI();
  });
}
function editExpense(id){
  const list = readJSON(K.exps, []);
  const it = list.find(x=>x.id===id);
  if(!it) return;
  const n = prompt('ğŸ“ Ù‚ÙŠÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø©:', it.amount);
  const v = num(n);
  if(v<=0) return;
  it.amount = v;
  writeJSON(K.exps, list);
  updateUI();
}

/* ---------- ØªÙ†Ø¸ÙŠÙ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ… ---------- */
function clearToday(){
  const list = readJSON(K.exps, []);
  const newList = list.filter(x=>x.date!==todayISO);
  if(newList.length===list.length) return;
  confirmBox('ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ØŸ', (ok)=>{
    if(!ok) return;
    writeJSON(K.exps, newList);
    updateUI();
  });
}

/* ---------- Ø­Ø³Ø§Ø¨ ÙˆØªØ±Ø­ÙŠÙ„ ÙŠÙˆÙ…ÙŠ ---------- */
function dailyRoll(){
  const last = localStorage.getItem(K.last);
  if(!last){ localStorage.setItem(K.last, todayISO); return; }
  if(last===todayISO) return;

  const list = readJSON(K.exps, []);
  const spentYesterday = list.filter(x=>x.date===last).reduce((s,x)=>s+x.amount,0);
  const daily = num(localStorage.getItem(K.daily));
  let carry = num(localStorage.getItem(K.carry));
  const saved = Math.max(daily - spentYesterday, 0);
  carry += saved;
  localStorage.setItem(K.carry, carry.toFixed(2));
  localStorage.setItem(K.last, todayISO);
}

/* ---------- ÙÙ„ØªØ±Ø© ---------- */
let filterFrom = null, filterTo = null;
function applyFilter(){
  const f = document.getElementById('fromDate').value || null;
  const t = document.getElementById('toDate').value || null;
  filterFrom = f; filterTo = t;
  updateUI();
}
function resetFilter(){ filterFrom=null; filterTo=null; document.getElementById('fromDate').value=''; document.getElementById('toDate').value=''; updateUI(); }

/* ---------- Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ---------- */
function saveBudget(){
  const cat = document.getElementById('budgetCat').value || 'Ø¹Ø§Ù…';
  const val = num(document.getElementById('budgetVal').value);
  if(val<=0) return;
  const map = readJSON(K.budgets, {});
  map[cat] = val;
  writeJSON(K.budgets, map);
  document.getElementById('budgetVal').value='';
  renderBudgets();
}
function clearBudgets(){
  confirmBox('ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§ØªØŸ', (ok)=>{
    if(!ok) return;
    writeJSON(K.budgets, {});
    renderBudgets();
    updateUI();
  });
}

/* ---------- ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ---------- */
function exportCSV(){
  const list = readJSON(K.exps, []);
  const rows = [['date','amount','category','note']].concat(
    list.map(x=>[x.date, x.amount, x.category||'', (x.note||'').replace(/"/g,'""')])
  );
  const csv = rows.map(r=>r.map(c=>/[,"]/.test(String(c))?`"${String(c)}"`:String(c)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `expenses_${todayISO}.csv`;
  a.click();
}
function exportJSON(){
  const data = {};
  [K.salary,K.fixed,K.daily,K.plan,K.percent,K.last,K.carry,K.exps,K.extra,K.budgets,K.monthKey].forEach(k=>{
    data[k]=localStorage.getItem(k);
  });
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `expenses_backup_${todayISO}.json`;
  a.click();
}
function importJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
      const backup={}; Object.keys(localStorage).forEach(k=>backup[k]=localStorage.getItem(k));
      localStorage.setItem(K.backup, JSON.stringify(backup));
      for(const [k,v] of Object.entries(data)){ if(v!==undefined && v!==null) localStorage.setItem(k, v); }
      updateUI();
      document.getElementById('restoreBtn').style.display='inline-flex';
      alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
    }catch{ alert('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
  };
  r.readAsText(file);
}

/* ---------- Ø·Ø¨Ø§Ø¹Ø© ---------- */
function printReport(){ window.print(); }

/* ---------- Ù…Ù„Ø®Øµ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ---------- */
function generateWeeklySummary(){
  const list = readJSON(K.exps, []);
  const extras = readJSON(K.extra, {});
  const p = num(localStorage.getItem(K.percent));
  if(!list.length && !Object.keys(extras).length){ document.getElementById('weeklySummary').style.display='none'; return; }

  const now = parseISO(todayISO);
  const day = now.getDay(); // 0=Sunday (Ø§Ù„Ø£Ø­Ø¯)
  if(!(day===0 || day===6)) { document.getElementById('weeklySummary').style.display='none'; return; }

  const lastKey = 'last_weekly_summary';
  const last = localStorage.getItem(lastKey);
  if(last===todayISO){ document.getElementById('weeklySummary').style.display='block'; return; }

  const start = new Date(now); start.setDate(now.getDate()-6);
  let total=0; const dayTotals={}; let maxSpent=0, maxDate='';
  list.forEach(e=>{
    const d=parseISO(e.date);
    if(d>=start && d<=now){
      total+=e.amount;
      dayTotals[e.date]=(dayTotals[e.date]||0)+e.amount;
    }
  });
  for(const [d,v] of Object.entries(dayTotals)){ if(v>maxSpent){ maxSpent=v; maxDate=d; } }

  let saving=0;
  for(const [d,val] of Object.entries(extras)){
    const dd=parseISO(d);
    if(dd>=start && dd<=now) saving += (num(val)*p/100);
  }

  const box = document.getElementById('weeklySummary');
  box.innerHTML = `
    <div class="section-title">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
    <div class="kv"><span>ğŸ§¾ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span><b>${total.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙˆÙÙ‘Ø± Ù…Ù† Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</span><b>${saving.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>ğŸ”¥ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£Ø¹Ù„Ù‰ ØµØ±ÙÙ‹Ø§</span><b>${maxDate?`${dayName(maxDate)} (${maxSpent.toFixed(2)} Ø¯)`:'â€”'}</b></div>
    <div class="alert alert-success">ğŸ‘ Ø´ÙØºÙ„ Ù…Ø±ØªØ¨! ÙƒÙ…Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¸ÙŠÙ….</div>
  `;
  box.style.display='block';
  localStorage.setItem(lastKey, todayISO);
}

/* ---------- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… ---------- */
function drawChart(){
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio||1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = w*DPR; canvas.height = h*DPR; ctx.scale(DPR,DPR);
  ctx.clearRect(0,0,w,h);

  const list = readJSON(K.exps, []);
  const map = {};
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const iso = fmtDate(d); map[iso]=0;
  }
  list.forEach(e=>{ if(e.date in map) map[e.date]+=e.amount; });
  const labels = Object.keys(map);
  const vals = labels.map(d=>map[d]);
  const max = Math.max(...vals, 10);
  const pad=24, barW = (w - pad*2) / labels.length * .7;
  labels.forEach((lb, i)=>{
    const x = pad + i*((w - pad*2)/labels.length) + (((w - pad*2)/labels.length)-barW)/2;
    const hBar = (vals[i]/max)*(h - pad*2);
    ctx.fillStyle = '#4a6fa5';
    const y = h - pad - hBar;
    ctx.fillRect(x, y, barW, hBar);
    ctx.fillStyle='#607d8b'; ctx.font='12px Tajawal';
    ctx.fillText(lb.slice(5), x, h-6);
  });
}

/* ---------- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© + Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙŠÙˆÙ… ---------- */
function renderStatsAndToday(){
  const daily = num(localStorage.getItem(K.daily));
  const carry = num(localStorage.getItem(K.carry));
  const extras = readJSON(K.extra, {});
  const extraToday = num(extras[todayISO]||0);
  const p = num(localStorage.getItem(K.percent));
  const baseSaving = num(localStorage.getItem(K.plan));
  const totalSavingToday = (baseSaving/(daysInMonth(new Date().getFullYear(), new Date().getMonth()+1)) + (extraToday*p/100));

  const list = readJSON(K.exps, []);
  const todayItems = list.filter(x=>x.date===todayISO);
  const spentToday = todayItems.reduce((s,x)=>s+x.amount,0);
  const effectiveLimit = (daily + carry + extraToday);
  const remaining = (effectiveLimit - spentToday);

  // today panel
  const todayPanel = document.getElementById('todayPanel');
  const alert = remaining<0 ? `<div class="alert alert-danger">âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù€ ${Math.abs(remaining).toFixed(2)} Ø¯</div>`
    : `<div class="alert alert-success">âœ… Ù…Ù…ØªØ§Ø²! ÙˆÙÙ‘Ø±Øª ${remaining.toFixed(2)} Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>`;
  todayPanel.innerHTML = `
    <div class="kv"><span>Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…ØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ…</span><b>${effectiveLimit.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</span><b>${extraToday.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø®Ø·Ø© Ø§Ù„ØªÙˆÙÙŠØ± (${p}%)</span><b>${totalSavingToday.toFixed(2)} Ø¯</b></div>
    ${alert}
  `;

  // Ø¥Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if(remaining<0 && window.Notification && Notification.permission==='granted'){
    try{ new Notification(`âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù€ ${Math.abs(remaining).toFixed(2)} Ø¯`) }catch{}
  }

  // stats
  const allDates = [...new Set(list.map(x=>x.date))];
  const totalSpent = list.reduce((s,x)=>s+x.amount,0);
  let maxSpent=0, maxSpentDate='â€”';
  const dayTotals={};
  list.forEach(x=>{ dayTotals[x.date]=(dayTotals[x.date]||0)+x.amount; if(dayTotals[x.date]>maxSpent){maxSpent=dayTotals[x.date]; maxSpentDate=x.date;} });
  const avg = allDates.length ? (totalSpent/allDates.length) : 0;

  document.getElementById('stats').innerHTML = `
    <div class="kv"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</span><b>${allDates.length} ÙŠÙˆÙ…</b></div>
    <div class="kv"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span><b>${totalSpent.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span><b>${avg.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø£ÙƒØ«Ø± ÙŠÙˆÙ… Ø¥Ù†ÙØ§Ù‚Ù‹Ø§</span><b>${maxSpentDate==='â€”'?'â€”':`${maxSpentDate} (${maxSpent.toFixed(2)} Ø¯)`}</b></div>
  `;
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ø¹ ÙÙ„ØªØ±Ø© ---------- */
function renderExpenseList(){
  const wrap = document.getElementById('expenseList');
  wrap.innerHTML='';
  const extras = readJSON(K.extra, {});
  const daily = num(localStorage.getItem(K.daily));
  let carry = num(localStorage.getItem(K.carry));

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
  const list = readJSON(K.exps, []);
  let filtered = list;
  if(filterFrom) filtered = filtered.filter(x=>x.date>=filterFrom);
  if(filterTo) filtered = filtered.filter(x=>x.date<=filterTo);

  // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
  const grouped = {};
  filtered.forEach(e=>{ (grouped[e.date] ||= []).push(e); });
  const dates = Object.keys(grouped).sort((a,b)=>parseISO(b)-parseISO(a));

  dates.forEach(date=>{
    const card = document.createElement('div');
    card.className='day-card';

    const header = document.createElement('div');
    header.className='day-header';
    header.innerHTML = `<div style="font-weight:700;color:var(--primary)">${dayName(date)} - ${date}</div>`;

    const items = grouped[date];
    const total = items.reduce((s,x)=>s+x.amount,0);
    const extra = num(extras[date]||0);
    const isToday = (date===todayISO);
    const limitThatDay = (daily + extra + (isToday?carry:0));
    const remaining = (limitThatDay - total);

    const info = document.createElement('div');
    info.innerHTML = `
      <span class="badge">Ø§Ù„Ù…ØªØ§Ø­: ${limitThatDay.toFixed(2)} Ø¯</span>
      <span class="badge">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toFixed(2)} Ø¯</span>
      ${extra>0?`<span class="badge">Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ: ${extra.toFixed(2)} Ø¯</span>`:''}
      ${isToday && carry>0?`<span class="badge">Ù…Ø±Ø­Ù„: ${carry.toFixed(2)} Ø¯</span>`:''}
    `;
    header.appendChild(info);
    card.appendChild(header);

    items.forEach(it=>{
      const div = document.createElement('div');
      div.className='expense-item';
      div.innerHTML = `
        <div>
          <div>Ù…ØµØ±ÙˆÙ: <b>${it.amount.toFixed(2)} Ø¯</b> â€” <span class="expense-meta">[${it.category||'Ø¹Ø§Ù…'}]</span></div>
          ${it.note?`<div class="expense-meta">ğŸ“ ${it.note}</div>`:''}
        </div>
        <div class="actions">
          <button onclick="editExpense('${it.id}')">âœï¸</button>
          <button onclick="deleteExpense('${it.id}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(div);
    });

    const summary = document.createElement('div');
    summary.className='hr';
    card.appendChild(summary);

    const alert = document.createElement('div');
    alert.className = remaining<0 ? 'alert alert-warning':'alert alert-success';
    alert.textContent = remaining<0 ? `âš ï¸ ØªØ¬Ø§ÙˆØ² Ø¨Ù€ ${Math.abs(remaining).toFixed(2)} Ø¯`
                                    : `âœ… ÙˆÙÙ‘Ø± ${remaining.toFixed(2)} Ø¯`;
    card.appendChild(alert);

    wrap.appendChild(card);
  });
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ---------- */
function renderBudgets(){
  const map = readJSON(K.budgets, {});
  const list = readJSON(K.exps, []);
  const month = todayISO.slice(0,7);
  const start = `${month}-01`; const end = `${month}-31`;
  const byCat = {};
  list.forEach(x=>{
    if(x.date>=start && x.date<=end){
      const c = x.category||'Ø¹Ø§Ù…';
      byCat[c]=(byCat[c]||0)+x.amount;
    }
  });

  const box = document.getElementById('budgetsView');
  if(!Object.keys(map).length){ box.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø©.</div>'; return; }
  box.innerHTML = '';
  Object.entries(map).forEach(([cat,limit])=>{
    const spent = byCat[cat]||0;
    const ratio = Math.min(spent/limit, 1);
    const row = document.createElement('div');
    row.style.marginBottom='10px';
    row.innerHTML = `
      <div class="kv"><span>${cat}</span><b>${spent.toFixed(2)} / ${num(limit).toFixed(2)} Ø¯</b></div>
      <div class="progress"><span style="width:${(ratio*100).toFixed(0)}%"></span></div>
      ${spent>limit?'<div class="alert alert-danger">ğŸš¨ ØªÙ… ØªØ¬Ø§ÙˆØ² Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ</div>':''}
    `;
    box.appendChild(row);
  });
}

/* ---------- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---------- */
function renderSettings(){
  const salary = num(localStorage.getItem(K.salary));
  const fixed = num(localStorage.getItem(K.fixed));
  const daily = num(localStorage.getItem(K.daily));
  const save = num(localStorage.getItem(K.plan));
  const p = num(localStorage.getItem(K.percent));
  document.getElementById('settingsCard').innerHTML = `
    <div class="kv"><span>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</span><b>${salary.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</span><b>${fixed.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (${p}%)</span><b>${save.toFixed(2)} Ø¯</b></div>
    <div class="kv"><span>Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span><b>${daily.toFixed(2)} Ø¯</b></div>
    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" id="editSettingsBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn-danger" id="deleteSettingsBtn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
    <div class="small" style="margin-top:6px">ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙˆÙÙŠØ± ÙŠÙˆÙ…ÙŠÙ‹Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ø®Øµ.</div>
  `;
  document.getElementById('editSettingsBtn').onclick = ()=>{
    document.getElementById('salary').value = localStorage.getItem(K.salary)||'';
    document.getElementById('fixed').value = localStorage.getItem(K.fixed)||'';
    calculate(true); // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
  };
  document.getElementById('deleteSettingsBtn').onclick = ()=>{
    confirmBox('ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.', (ok)=>{
      if(!ok) return;
      localStorage.removeItem(K.salary);
      localStorage.removeItem(K.fixed);
      localStorage.removeItem(K.daily);
      localStorage.removeItem(K.plan);
      localStorage.removeItem(K.percent);
      updateUI();
    });
  };
}

/* ---------- ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---------- */
function updateUI(){
  dailyRoll();
  renderSettings();
  renderStatsAndToday();
  renderExpenseList();
  renderBudgets();
  drawChart();
  generateWeeklySummary();

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
  document.getElementById('restoreBtn').style.display = localStorage.getItem(K.backup)?'inline-flex':'none';
}

/* ---------- Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© ---------- */
document.getElementById('calcBtn').onclick = ()=>calculate(false);
document.getElementById('addExtraBtn').onclick = addExtra;
document.getElementById('addExpenseBtn').onclick = addExpense;
document.getElementById('clearTodayBtn').onclick = clearToday;
document.getElementById('applyFilterBtn').onclick = applyFilter;
document.getElementById('resetFilterBtn').onclick = resetFilter;
document.getElementById('saveBudgetBtn').onclick = saveBudget;
document.getElementById('clearBudgetsBtn').onclick = clearBudgets;
document.getElementById('exportCsvBtn').onclick = exportCSV;
document.getElementById('exportJsonBtn').onclick = exportJSON;
document.getElementById('importJsonInput').addEventListener('change',e=>{ if(e.target.files?.[0]) importJSON(e.target.files[0]) });
document.getElementById('printBtn').onclick = printReport;

document.getElementById('resetBtn').onclick = ()=>{
  confirmBox('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ', (ok)=>{
    if(!ok) return;
    const backup={}; Object.keys(localStorage).forEach(k=>backup[k]=localStorage.getItem(k));
    localStorage.setItem(K.backup, JSON.stringify(backup));
    localStorage.clear();
    localStorage.setItem(K.backup, JSON.stringify(backup));
    location.reload();
  });
};
document.getElementById('restoreBtn').onclick = ()=>{
  confirmBox('ğŸ“¦ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ', (ok)=>{
    if(!ok) return;
    const data = readJSON(K.backup, null);
    if(!data){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù…ØªØ§Ø­Ø©'); return; }
    for(const [k,v] of Object.entries(data)){ if(v!==null) localStorage.setItem(k,v); }
    updateUI();
  });
};

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®Ø²Ù†Ø©
  document.getElementById('salary').value = localStorage.getItem(K.salary)||'';
  document.getElementById('fixed').value = localStorage.getItem(K.fixed)||'';
  updateUI();
});
</script>
</body>
</html>
